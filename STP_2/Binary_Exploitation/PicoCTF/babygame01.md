# babygame01
## Description
Get the flag and reach the exit.
Welcome to BabyGame! Navigate around the map and see what you can find! The game is available to download here. There is no source available, so you'll have to figure your way around the map. You can connect with it using nc saturn.picoctf.net 57841.
## Hints
- Use 'w','a','s','d' to move around.
- There may be secret commands to make your life easy.
## Solution
- We're given [game](./game). Connecting to the server:
```
Player position: 4 4
End tile position: 29 89
Player has flag: 0
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
....@.....................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```
- We can move around using `w`, `a`, `s`, `d` keys. Using `w`:
```
Player position: 3 4
End tile position: 29 89
Player has flag: 0
..........................................................................................
..........................................................................................
..........................................................................................
....@.....................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```
- Our goal is to reach the `X` tile. Opening the file in IDA and clicking `F5`, we see the following pseudocode for `main`:
```c
int __cdecl main(int argc, const char **argv, const char **envp)
{
  char v4; // [esp+1h] [ebp-AA5h]
  _DWORD v5[2]; // [esp+2h] [ebp-AA4h] BYREF
  char v6; // [esp+Ah] [ebp-A9Ch]
  _BYTE v7[2700]; // [esp+Eh] [ebp-A98h] BYREF
  unsigned int v8; // [esp+A9Ah] [ebp-Ch]
  int *p_argc; // [esp+A9Eh] [ebp-8h]

  p_argc = &argc;
  v8 = __readgsdword(0x14u);
  init_player(v5);
  init_map(v7, v5);
  print_map(v7, v5);
  signal(2, (__sighandler_t)sigint_handler);
  do
  {
    do
    {
      v4 = getchar();
      move_player(v5, v4, v7);
      print_map(v7, v5);
    }
    while ( v5[0] != 29 );
  }
  while ( v5[1] != 89 );
  puts("You win!");
  if ( v6 )
  {
    puts("flage");
    win();
    fflush(stdout);
  }
  return 0;
}
```
- `v7` is a large buffer, it probably is used to store the map. This is the code of `initplayer`:
```c
int __cdecl init_player(int a1)
{
  int result; // eax

  *(_DWORD *)a1 = 4;
  *(_DWORD *)(a1 + 4) = 4;
  result = a1;
  *(_BYTE *)(a1 + 8) = 0;
  return result;
}
```
- `v5` starts from `esp+2h`. We store 2 `DWORD` values in `v5`. They are integers so 4 bytes. So `esp+2h` - `esp+5h` is first integer and `esp+6h` - `esp+9h` is second integer. We store a single byte in `esp+Ah` as `0`, which is also `v6`. So `v6` is initialised with `0`. `v5[0]` and `v5[1]` are the player's x and y coordinates respectively and the game always starts at (4,4).
- Taking a look at `init_map`:
```c
Elf32_Dyn **__cdecl init_map(int a1, _DWORD *a2)
{
  Elf32_Dyn **result; // eax
  int i; // [esp+8h] [ebp-Ch]
  int j; // [esp+Ch] [ebp-8h]

  result = &GLOBAL_OFFSET_TABLE_;
  for ( i = 0; i <= 29; ++i )
  {
    for ( j = 0; j <= 89; ++j )
    {
      if ( i == 29 && j == 89 )
      {
        *(_BYTE *)(a1 + 2699) = 88;
      }
      else if ( i == *a2 && j == a2[1] )
      {
        *(_BYTE *)(90 * i + a1 + j) = player_tile;
      }
      else
      {
        *(_BYTE *)(90 * i + a1 + j) = 46;
      }
    }
  }
  return result;
}
```
- `init_map` initialises the map. The player is represented by `@`. The player's position is stored in `v5`. The map is stored in `v7`. The map is a 30x90 grid. The player's position is updated in the map using `player_tile` which is `0x40` or `@` in ASCII. The rest of the map is filled with `.`.
- `print_map` doesn't have anything particularly interesting:
```c
int __cdecl print_map(int a1, int a2)
{
  int i; // [esp+8h] [ebp-10h]
  int j; // [esp+Ch] [ebp-Ch]

  clear_screen();
  find_player_pos(a1);
  find_end_tile_pos(a1);
  print_flag_status(a2);
  for ( i = 0; i <= 29; ++i )
  {
    for ( j = 0; j <= 89; ++j )
      putchar(*(char *)(90 * i + a1 + j));
    putchar(10);
  }
  return fflush(stdout);
}
```
- Moving on, taking a look at `move_player`:
```c
_BYTE *__cdecl move_player(_DWORD *a1, char a2, int a3)
{
  _BYTE *result; // eax

  if ( a2 == 'l' )
    player_tile = getchar();
  if ( a2 == 'p' )
    solve_round(a3, a1);
  *(_BYTE *)(a1[1] + a3 + 90 * *a1) = 46;
  switch ( a2 )
  {
    case 'w':
      --*a1;
      break;
    case 's':
      ++*a1;
      break;
    case 'a':
      --a1[1];
      break;
    case 'd':
      ++a1[1];
      break;
  }
  result = (_BYTE *)(a1[1] + a3 + 90 * *a1);
  *result = player_tile;
  return result;
}
```
- We see the `wasd` moves as usual. But `l` and `p` are interesting. `l` reads a character from the input and stores it in `player_tile`. So using `la`:
```
Player position: 4 4
End tile position: 29 89
Player has flag: 0
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
....a.....................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```
- Running `p`:
```
Player position: 29 89
Player has flag: 0
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................a
You win!
```
- The game skips to the `X` tile automatically, saving us keystrokes. But we don't have the flag yet.
- We can also see there are no sanity checks for the player's position. We can move out of bounds. We can use this to our advantage.
- `win` is called if `v6` is not null. Since `v6` is declared just before the buffer, we can move to (0,0) and then click `a` 4 times to modify `v6`. This is because `v6` is a 32-bit aligned word in the stack frame and since we want to modify the LSB keeping little-endian in mind, we need to move 4 bytes to the left. Doing this:
```
End tile position: 29 89
Player has flag: 64
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```
- We can see the `Player has flag` is now `64`. This is the ASCII value of `@`. We can now move to the `X` tile using `p` and get the flag:
```
Player position: 29 89
Player has flag: 46
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................@
You win!
flage
picoCTF{gamer_m0d3_enabled_6aeb6b85}
```
- The flag is `picoCTF{gamer_m0d3_enabled_6aeb6b85}`.