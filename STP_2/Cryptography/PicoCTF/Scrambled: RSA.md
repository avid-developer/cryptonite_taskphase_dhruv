# Scrambled: RSA
## Description
Hmmm I wonder if you have learned your lesson... Let's see if you understand RSA and how the encryption works. Connect with `nc mercury.picoctf.net 6276`.
## Hints
- Look at the ciphertext, anything fishy, maybe a little bit long?
- What happens if you encrypt the same input multiple times?
- Is RSA deterministic, why would outputs vary?
## Solution
- Connecting to the server, we are given the following:
```
flag: 318787643215295999027347755438369549928736824390666836229743179745515727290958023729800156987097238826797044631298674462027080321047653982483726628617614419626747211488338983569576660710809997131482295065655626744168155002529781374861200388575441039044496167270242815180001343068751568180515331848877086865871163709266399021874422789532459787915736981365229552250349136706430243923169102679791348263766572295280273566527185376703322625251827387522445249255602226653457190306394586689874553936084209023006122330380698279065428774432983769173319468633911025454170897603710124843846040710585706637720808561759071451182091317330073432625033435817367660560890319607220635346660776971694706811775925842229074717003683240385506538828111562683913410500865285382467539962231055477616780142572994260196447902941971522061662829373983599203182837798059477359045624636453320755647715165441988419458775048674435664751759389492725209755799736646442109648108409531968298553541442127751221979176969971779864778905417840895461285200997684753377107121355120052102591159276246520334466166791378782339186033328193599227284697169535675963768161619458217505935436837627543933286963844214451738673891846997876676704180185601696140750948653651509107496857242711062532085521638019091737952171447449792546538005874744381780876343734238369070339240222799114217181221131114951309285052201004622711618551160429928290026689190515200509290686754482236627789170137498631061696545357611575607852840873951140641193202124067305510295378137623472500438694346659270741295654532887083254998612451345524611616518154165832415926551289889595218396469729759177013201353355885552327996019212626266478117627421586736866154157483493378634754160562764726175489816987864556344009221931034503172595320984916172104738412298670398565509910035989743518390229181974139284245280798870315499413667480496525630174686558970759883303867233368056583103980505744053540163466206967887693161465309900194784374565053244317422052486961293466749403677459684533759712932779130427700837394254854163313188724017776522499143946612729977542428177643587247812382167978878404819020994967817982268439847038821518136393142392522474293891167711870009233583579865894949094800414070004188815114314385221218668712594449490843615629086391495316977242274411071281403198548063535630848261680515282682767996600942131987467848905037479643932252265938723890365813404640320501433554257091742276149955580263773567746225889216777855271139167379507936994554052599741286227982967021745590424807050688714186570410256383409390768861598268873770928472803773939477569924430227163348902115253437288776137218754816296102296716738960092376033412471557839477615174367575684348956838184153688157894827225125938143667180068065829881916035452843068304225396902631620379231721151304292011314171851119627102708256921189140159740790392838680774912309386505166526652014328885923644881346190259423530963449381991269325595457197380884497817998416942398644071942451428057273952007669873040334202740731174947981130645375722658664573924405930497943014962756014808661224071194054027851097771238803776011581293197501477436157338431850105485610415901744760627773511211271284636355232864973599547236943733814041674731349811075839875268204702685980900172972881016228807427418013474247760349308622366854775521640528639067786537994402405253307207897018587143785170810653870510297158167705035771315369628454572600421131054608677879625234752580912349698710013657860338700280980210563266240948413853748539412374161731992408594059526159891263385157023109396478383660528030823412486437165317385589773048073739760673407123671701597920622340860947128163849509743409937444079382423101026765293382032857304450537881016680279641884314661808619947205343262703253695060869685062283860647660116137764646640907775013616018852753255147490325896485750003635884190877762039595273928420813131564530932621312608162757253988756343531961429793272156832520894064610018230523053151138220959277468019726485969095478435963904761879239741057354938291175253329416415933963358685740247729526807023296202716851645727952072922938553766121682184611560426941168802462243931710455015240549446326381828567993691458252391860449224910502067342083255041226384640030021952632147247155046216794666842341208565266857370191789044490559718705597045535058019056927083961294283129006388024212810275533984320481449905272270562020283708426787826315624859563027468671147546329987061466085133648690924554169863032635911493996230562127895728426215188883703126915846546834846926401894844708873848759888451477317763050876935322870619701569170794575292686969577359903044104168190175603711076756447308831670349296304055140991923128234558461290815203230765777202957170688249181263477940795489800368555921586479417457633527873920002885544145561925447925668174265604551943874143566751140721555855211553735583190371989441190131510511164295487341026049297868656221289402600481216031188446967050862573834258123835354542509833251463505542518518491024235890409907773651037437840678402782062302423267219861943362093962935308000244019956919662413282995277873298412605748541748046759687076554105732471958079534649123091921101482799380293645994595304761450389148530276144478431081623085761641230872245970106292965123881015931559341610595572588514927175745593248201907668171824086118025181170384624982185085229548436795314938167654493800830095393201299607954087981333035612722356138657346780777768834794026763939860841427971510739020426269525442982783049553757793051155496048474586934548030776695383669870334772886554337188417945631623186519448085324049431581643969107834927106562367626905443878871845753000152805777895229989746083849149567623902076723214919446849664881134667929953107849652854667643248266581330051854795991264656083425808063348983670992071215477120021192696152552643620793694267881599649475391752111953433356657945639715126177080905151968780081822352801420031025878549911461208680174565986127616010632708546001152309391143025930301773744910435658046843826141119986390992822641546021011196045728656832431764541810019723312448586343752141501611212429706630707451925746150289266423761752405066317852197940671472845276258979496957091337769345744623831764117616506947368318996936440774647427812647179035501179145248814377276914956234596381633945693275498368377932579397829064446885502037757908937643028915274755764846995412809914238778163273389458743931579647222973500613649370322327837025302034882129993839068032852347546080175450493730424831109656280685187901415357408467881558986325214405121042427043317853687195730809277603873675545043156472691528878416763642560273547619210691099023847189570631576695107537537200698961793763385899756746652638119056357759415756537257980799213337734888997832551038779621167160093821143688427390858969225461816176231092246801869862214647785710619399772278012944423419717190921797369187759568781983204384755150605080841837067671015656333350463857246494496472240759182721567027406838285962937149759487300017585014950145882317159651107377678160543382193550147740619857997563220138688922440043040214040050380236980053388980065011152266335319182035794165463051902409638468612355472968780812637517124966886938589578423054120640490552915769429828324330378427710393320895403087691529473906619395328227416898677523818187937526372782521507283950742988086740200861423277898868698920110110654415128328689181627700448645839747529289691637178864522009017525771652633054376622370269112505331957186462087499781157035785794797434375194427074745798466107219373751335267627876414112036936445245541300352073209592998799139653930566619054323422524336383211502004690554321249884205350142384377967825299277988941026733420683697278392180581533457479133755482938940633414645325017755544531546297199862311522250750974938290274591743204924497786778938914832230727368485646446878651630267693622627310532101645589993095036404728592708633500679729760906675137598898188735568037139796676763760382656087561095539157354359620007261147628539218236590988974686932974304651781594284516
n: 133040966081769066518059014301102062139170033426924646689953561815866369806795529148717360165856787923439019118484615782717561546007015433002013219648923500710184565785519264738595575166463130603993649552206836580810514872006834583165613380756255631054811417489374555872108840895462776247737162386875146247187
e: 65537
I will encrypt whatever you give me: 
```
- Right of the bat, we can see that the `flag` is much larger than `n`.
- Sending a `1` or a `0` to the server should give us `1` and `0` respectively if this is a simple RSA encryption.
```
I will encrypt whatever you give me: 0
Here you go: 61867185943383274883541484350788003050730030455488243389422628678703744924684238720418777715637614868015096662324023841892591769912850312068566032766234514562224776421693160958740333593580842250380316229553623157137664049091416362559353779274858951852281099145937612002653735546158951448201094387731683568708
I will encrypt whatever you give me: 1
Here you go: 73907747358006784178600074386581213229853890621754337789218810681671692353560180088776318026041591814942348403942301905751401624053197781115070431788172320912449256100318979053688978618137691300502836925617892048616384505249204534451858111646544272898218638656769645855271417716260535134214812236982421356785
```
- So this is not your typical RSA encryption.
- Sending the same single character multiple times gives us the same ciphertext.
```
I will encrypt whatever you give me: 4
Here you go: 41986551149194032024242045764565321708119242509408303810290641459858247354773683840231211331689085303161259851593890540007692133799597642436486531979830422767401292637943796538090310874514573364490040423927794812796287756010626035928638716378956486844606212794190390435388256780838617183811474890599394888715
I will encrypt whatever you give me: 4
Here you go: 41986551149194032024242045764565321708119242509408303810290641459858247354773683840231211331689085303161259851593890540007692133799597642436486531979830422767401292637943796538090310874514573364490040423927794812796287756010626035928638716378956486844606212794190390435388256780838617183811474890599394888715
I will encrypt whatever you give me: 4
Here you go: 41986551149194032024242045764565321708119242509408303810290641459858247354773683840231211331689085303161259851593890540007692133799597642436486531979830422767401292637943796538090310874514573364490040423927794812796287756010626035928638716378956486844606212794190390435388256780838617183811474890599394888715
```
- Giving a few more test inputs: 
```
I will encrypt whatever you give me: 45
Here you go: 3748797766952159615241235263659552809214306065620788104875952236663222073928196879862127478223973220838879921616475306938846069112068567994122660117431679834014594916890739333286891773527667619828977033641980049170052792152034503556426109127745905187201448592995965077900430970673514659824813967705052955462841986551149194032024242045764565321708119242509408303810290641459858247354773683840231211331689085303161259851593890540007692133799597642436486531979830422767401292637943796538090310874514573364490040423927794812796287756010626035928638716378956486844606212794190390435388256780838617183811474890599394888715
I will encrypt whatever you give me: 45
Here you go: 4198655114919403202424204576456532170811924250940830381029064145985824735477368384023121133168908530316125985159389054000769213379959764243648653197983042276740129263794379653809031087451457336449004042392779481279628775601062603592863871637895648684460621279419039043538825678083861718381147489059939488871537487977669521596152412352636595528092143060656207881048759522366632220739281968798621274782239732208388799216164753069388460691120685679941226601174316798340145949168907393332868917735276676198289770336419800491700527921520345035564261091277459051872014485929959650779004309706735146598248139677050529554628
I will encrypt whatever you give me: 456
Here you go: 419865511491940320242420457645653217081192425094083038102906414598582473547736838402312113316890853031612598515938905400076921337995976424364865319798304227674012926379437965380903108745145733644900404239277948127962877560106260359286387163789564868446062127941903904353882567808386171838114748905993948887154193879477040694421979402976313424828716110956069843712584186078042532558864649656097895264569831164957857127653008846675389052670603570145187196325196531762931334070817648297555607405162593673004623891745392986141435034739203607995359564035755985692985064056868099551828297699880239024576856303274362770746437487977669521596152412352636595528092143060656207881048759522366632220739281968798621274782239732208388799216164753069388460691120685679941226601174316798340145949168907393332868917735276676198289770336419800491700527921520345035564261091277459051872014485929959650779004309706735146598248139677050529554628
I will encrypt whatever you give me: 5
Here you go: 42986828780782340573648187925027934862514192780655570254740938465633106283990694085434450561829209473327728202077951009716984670655621228181511594338238841825391071505116440180031067408446346992486413145202301203589467750522252899157125604875031045911763291896928693949679641196461792800285650296458137356954
I will encrypt whatever you give me: 456
Here you go: 374879776695215961524123526365955280921430606562078810487595223666322207392819687986212747822397322083887992161647530693884606911206856799412266011743167983401459491689073933328689177352766761982897703364198004917005279215203450355642610912774590518720144859299596507790043097067351465982481396770505295546284198655114919403202424204576456532170811924250940830381029064145985824735477368384023121133168908530316125985159389054000769213379959764243648653197983042276740129263794379653809031087451457336449004042392779481279628775601062603592863871637895648684460621279419039043538825678083861718381147489059939488871541938794770406944219794029763134248287161109560698437125841860780425325588646496560978952645698311649578571276530088466753890526706035701451871963251965317629313340708176482975556074051625936730046238917453929861414350347392036079953595640357559856929850640568680995518282976998802390245768563032743627707464
I will encrypt whatever you give me: 6
Here you go: 85883127159075282373889099778077200307032840175236457343871580684151407925540199576035348663700860926944927484273616727549656958458019022371856732490749404910715488600228318640155859723102825988012115228264026480568540644630379589065588709628925231080344672450659143999188397193491643837106679033768864122422
```
- A few observations:
  - The ciphertext is not always the same for inputs having more than a single character, so the encryption is not deterministic it seems.
  - the cipher for `45` seems to be about twice the length of the cipher for `5` or `4`, suggesting that there is probably some concatenation happening.
  - Taking a closer look at the 2 different ciphers of `45`:
    - We can see that the cipher for `4` is a part of the cipher for `45`.
    - If we remove the cipher for `4` from the cipher for `45`, we get the same cipher in both cases.
    - This suggests that the cipher for `45` is the concatenation of the cipher for `4` and the cipher for `5`, but the cipher for `5` is not the same as the cipher for `5` alone.
    - This suggests that the position of the character in the input string is also being considered.
    - We can see the same pattern in the ciphers of `456`
- We can use this information to decrypt the flag.
- I wrote the [Scrambled_RSA.py](./Scrambled_RSA.py) script to decrypt the flag.
```python
from pwn import remote
import string

# Connect to the server
HOST = 'mercury.picoctf.net'
PORT = 6276
conn = remote(HOST, PORT)

conn.recvuntil(b'flag: ')
encrypted_flag = conn.recvline().decode().strip()
print(f'Encrypted flag: {encrypted_flag}')

# Ignore N and e (not required)
conn.recvline()
conn.recvline()

# Decrypt the flag
decrypted_flag = ''
removecipher = []

while "}" not in decrypted_flag:
    for c in string.ascii_lowercase + string.digits + "{}_CTF":
        curr = decrypted_flag + c
        conn.sendlineafter(": ", curr)
        conn.recvuntil(b': ')
        curr_cipher = conn.recvline().decode().strip()
        for cipher in removecipher:
            curr_cipher = curr_cipher.replace(cipher, "")
        if curr_cipher in encrypted_flag:
            print(decrypted_flag + c)
            decrypted_flag += c
            removecipher.append(curr_cipher)
            break
print(f'Decrypted flag: {decrypted_flag}')
conn.close()
```
- The script uses a brute force approach to decrypt the flag:
  - It uses a while loop to keep trying characters until the closing brace `}` is found in the decrypted flag, which means the flag has been decrypted.
  - It checks each character from the set of lowercase alphabets, digits, and the special characters `{`, `}`, `_`, `C`, `T`, `F` as these are the characters that are generally part of a picoCTF flag.
  - For each character, it constructs a candidate string `curr` by appending the character to the current `decrypted_flag`.
  - It sends this candidate string to the server and receives the corresponding cipher text.
  - It then removes the ciphers of the characters that have already been taken care of before from the current cipher text.
  - If the resulting cipher text is found in the `encrypted_flag`, it means a new flag character has been found, and the corresponding character is added to the `decrypted_flag`.
  - The cipher text corresponding to this character is appended to the `removecipher` list so that it can be removed from the cipher text of subsequent iterations.
- Running the script gives us the flag.
```bash
[+] Opening connection to mercury.picoctf.net on port 6276: Done
Encrypted flag: 564832258607159422747919127246710707060962311508222192251697126956639288040603491907051658140441441036441429596043172067736800977270566366635335802581121971682745920935632892254576008508011848919049396566275633736558123604358884740485077587758847860198470666540061566748404645191234025017846457319766644648370350088541998890013630345934441036987949224847361110015401969634138069071266429731320054114230370344579324275544664467194490359853058576212102162862766743270417293700327909899181674473007923903276379351626528529923061071665775142204212561382623861967307838050115619976508581763426004922331895713120549003730254399440231201483959008624007272726056433479966414176958426526488864060083835594053313671839606331475218219406603313588094403838005028270149329094482003527155281565284205656574638150829339909907451874076311927951840231285179625296594449466889612224980143681027402059183592547568883813049198389339269303865434079638338163509052958261256173616613218223118249589690507528783742276998686465342167002481503776114686290260547844367756726558737586783888065691850238517843318123985256587249054759888153023429906955411699834993855821034574063748275749379928519491383000781139604722771850957244139153183428684285421680602435380336011548537740795885745541904687324631706199850153382409881057899820821776271487697952183816603023640672812290480270869217301451160629039832047986377692152523943011018797544945742455645636775255400847791238981171469109419512880014867590186826564286953903846757248602382985388082608312782332234723481067300443338654609444170311305033672684710458493410954813094897138204506390556563586745998200361668231185332799397278374170635918230700821389282342470432721934633445194289853083281920040015897459706160361472458097623756146223493555514920142582331075509477080873764882605408842520543596592342913053117673835460058701926980634764000721136250768620781197459121274147785902526770628121058051458162780991267103871311279350716109226093210559617189436213736206943081551759663598290132402775383080224264581411211962304495901064291671060057345606675378309125433566494510105037025081066859615738959712370333708454898746816970492119081936910143552891910249659789242949601225367186222400195005472725040724210199059477397222297903903443039686983701294952940166877436599059451840411367464247854028364361018289314363233639595650199757333015021670719842787689625475658372754031933343505053664355232424481034128213799563746546999039638882683868134751423720861558630691897722496273872849119062925149829134237886230427165434023653821505801165924586105970324562483987355340699918176339317671552316000365786952478037598355316360596317632052425100015037229023635092669734394524942860667709465831443793734272060510604246446072017605364304785001186285049780212614773245510715828188555656517391986126278407500044388252605503172721932045272212036565259958155607273169366524904405926924488917795312971922312138052010645274664816806880711794647708159123025807576614728630226150171265712692041962633227228417473616052072616689501062503235632730285644744705315660117689024069191434779255634163190307778311046767835767898401392510262256142579160489760855548243286455901627873034145113292567222478693197271489022435571918961196173412581699982792733213707573468516876086418170584189147822645982804083187964070618738700444959365712995741401112852360057279950064956350016577857595581170162596968321384293077723273786120634953477773942960620783185799846087068397006045790914959891822548673968875173742447654413904451388978677547322896543892073276919933304810325646385911584295046351834720974316315654073828373630037520702620650249200352406265725182307165098154643820530788949142962185788979412382347513322457892241724160981103151466398676627424696475546901048345771722134430816795880962811251615292737249653910321671853259212421114566184479460208563018248548424187749538503808073823183184728583582423014890572232993957263625954628030954155363369148166311563583693156893914558500221766938327026186095811505901406468934896664141113925075369199018949396742599477768334381689402066772615796690894087558465485580863309021779392266111734323005604637314139067429689820610966626631865627698779734994198775695628915719296115000048633807888010860851424831626395617230022342262278010387524147497176315637415043602692294379529530747153668651152163168082842145755621546621642056173465352299217593328793965066969490449406563504751994689603932123411262683260062592812564773669848672271526890372049803215111993364776805325505282797646472750894949823528047594998039665597365249522785664858129984815840133976279540856513390051140132807982656122008705467799519738423836719730732321497134649947119161015036266113137735960071424531337381984955731417395361152297559707851655961189638968810707059214624393300770672823632875208314422186776122581039529078575783945176257705241315227587695003567825549747472990492271398073345005603088353679858119741129352366464296147759754185203736208392995787200589157721587435600562920221095638119373492585582387065817311155025693316916927552882477342307440623830042600067294344439509526029039047437283021271031793100645347077260917740600474247117492219262517788222416617953948656979308254009341494907444528622686941626145623032348039094578154026911705363609506808871769470624436402072657548294119324684163423220559355885507335242060464564697246537428746639529595373229999374501759307420705975017714720916289255986553506951193017758963907925760578104656832814590337678400734718506578165560238837481612073389149253453604810722797697436738528922822577561130135029828311218337477764756702674991070725569721765928782541727779549075974055033107327572556464169123423439930571466832141312109844005413127663749879839996919091068487880288877461212420862702515853353792299924065964627893914416826382316638649158602942550973784791765126647662050697546343315978592336661973756983711466803625717854284126040478801891176270899782441722983576654588913349290795894952175603875603344353807943140132824859935156164553528335785900809768442598234076589025268284498204855426540085818734634853129436227547211841061346432772382276861107329323971989022039440413502542008486731845556488166067729306500574318264452504399138392398930255105317056769750761167170414422858559851801158574850161951272673594398076294736400165244507189025853961635298367334346593781754439444971893595370661490742075813325551942705615944368992380407795416521899775159424927974641910271877930848620869668436848155024918694234075548612127331350736936701597238380028054191617000163623926805701853130113698770619393308616309907752474540191464880322885352000379074242555901674189054559275370125170730571030350829146551653574682160542894216839226802155611897409393431942917053368524605375408469514511912059735327643214694127284587820259918527336062826352774391616377093890925152594421935391173377202616107296551952774781991288790533826738843061548826566440074618191765723350868051255734649463612303524447551243628391541657189226514169770222646178339637571618563633762839496342513223783034644381578198960237122867537612005733258929234250643625780242042415758909274046456343128080251234149986515060863578089776434669817900649808788736465467324412873748205589534421068659043997747281301613844339906677401255430579724519206826494588194002373820620636590117689892179873909787788342350192045198160304372665990470468167444089250588006720708578775549300662576818400480851660690029300529609085778892863985327962713222135933905854126238055742077625830218460793197775327978297190855112042247449615339150674752047248705790021172285603735756723206200809914077918363266537017387289039612056429805653037030850458855406540225466132335080578888371188856685756256856630707011813271072080822089356738924269595417323068114209086151443832524132953662733386430069528879977714679951571547249734244547277770406990693954004791061427635603621253126999309998818653576557018488548532113745084089497008603693017719172143081712619287608283646829745587079480369866793598930080504961206
/Users/Dhruv1/Desktop/playground/SP/Taskphase/Cryptonite/cryptonite_taskphase_dhruv/STP_2/Cryptography/PicoCTF/Scrambled: RSA.py:25: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  conn.sendlineafter(": ", curr)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pwnlib/tubes/tube.py:841: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  res = self.recvuntil(delim, timeout=timeout)
p
pi
pic
pico
picoC
picoCT
picoCTF
picoCTF{
picoCTF{b
picoCTF{ba
picoCTF{bad
picoCTF{bad_
picoCTF{bad_1
picoCTF{bad_1d
picoCTF{bad_1d3
picoCTF{bad_1d3a
picoCTF{bad_1d3a5
picoCTF{bad_1d3a5_
picoCTF{bad_1d3a5_2
picoCTF{bad_1d3a5_22
picoCTF{bad_1d3a5_226
picoCTF{bad_1d3a5_2268
picoCTF{bad_1d3a5_22686
picoCTF{bad_1d3a5_226868
picoCTF{bad_1d3a5_2268684
picoCTF{bad_1d3a5_2268684}
Decrypted flag: picoCTF{bad_1d3a5_2268684}
[*] Closed connection to mercury.picoctf.net port 6276
```
- This challenge didn't require any deep knowledge of RSA encryption.